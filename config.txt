# ===========================================
# requirements.txt - Dependencias Python
# ===========================================

Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Login==0.6.3
Werkzeug==3.0.1
requests==2.31.0
cryptography==41.0.7
pywin32==306
psutil==5.9.6
Jinja2==3.1.2
MarkupSafe==2.1.3
itsdangerous==2.1.2
click==8.1.7
blinker==1.7.0
SQLAlchemy==2.0.23
typing_extensions==4.8.0
cffi==1.16.0
pycparser==2.21

# ===========================================
# config.ini - ConfiguraciÃ³n Principal
# ===========================================

[DATABASE]
# ConfiguraciÃ³n de base de datos
path = data/emergency_system.db
encryption_enabled = true
backup_interval_hours = 24
max_backup_files = 30

[SERVER]
# ConfiguraciÃ³n del servidor web
host = 0.0.0.0
port = 5000
debug = false
ssl_enabled = true
ssl_cert_file = ssl/server.crt
ssl_key_file = ssl/server.key

[SECURITY]
# ConfiguraciÃ³n de seguridad
secret_key = emergency-system-villa-allende-2024-secure-v2
session_timeout_minutes = 60
max_login_attempts = 5
lockout_duration_minutes = 30
password_min_length = 6

[LOGGING]
# ConfiguraciÃ³n de logging
level = INFO
file = logs/app.log
max_size_mb = 10
backup_count = 5
format = %(asctime)s - %(name)s - %(levelname)s - %(message)s

[WHATSAPP]
# ConfiguraciÃ³n de WhatsApp (configurar desde el panel web)
api_url = https://www.waboxapp.com/api/send/chat
token = 
uid = 
timeout_seconds = 30

[EMERGENCY]
# ConfiguraciÃ³n especÃ­fica de emergencias
default_priority = verde
auto_whatsapp = true
protocol_107_enabled = true
triage_required_medical = true

[SYSTEM]
# ConfiguraciÃ³n del sistema
version = 2.0.0
install_date = 
admin_email = admin@villaallende.gov.ar
organization = Municipalidad de Villa Allende
location = Villa Allende, CÃ³rdoba, Argentina

# ===========================================
# version.txt - InformaciÃ³n de VersiÃ³n
# ===========================================

2.0.0
Build: 20240127
Sistema de Emergencias Villa Allende
VersiÃ³n con base de datos corregida
Campo email agregado en tabla personas
MigraciÃ³n automÃ¡tica implementada
Instalador NSIS completo

# ===========================================
# install.bat - Instalador Windows
# ===========================================

@echo off
chcp 65001 >nul
setlocal enabledelayedexpansion

echo ================================================
echo ğŸš¨ SISTEMA DE EMERGENCIAS VILLA ALLENDE v2.0
echo    Instalador AutomÃ¡tico Windows
echo ================================================
echo.

:: Verificar permisos de administrador
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo âŒ Este instalador requiere permisos de administrador.
    echo    Ejecute como administrador y vuelva a intentar.
    pause
    exit /b 1
)

echo âœ… Permisos de administrador verificados
echo.

:: Verificar Python
echo ğŸ Verificando Python...
python --version >nul 2>&1
if %errorlevel% neq 0 (
    echo âŒ Python no encontrado en el sistema.
    echo    Instale Python 3.8+ desde https://python.org
    echo    AsegÃºrese de marcar "Add Python to PATH"
    pause
    exit /b 1
)

for /f "tokens=2" %%i in ('python --version 2^>^&1') do set PYTHON_VERSION=%%i
echo âœ… Python %PYTHON_VERSION% encontrado
echo.

:: Crear directorios
echo ğŸ“ Creando estructura de directorios...
if not exist "static\uploads" mkdir "static\uploads"
if not exist "backups" mkdir "backups"
if not exist "logs" mkdir "logs"
if not exist "data" mkdir "data"
if not exist "ssl" mkdir "ssl"
echo âœ… Directorios creados
echo.

:: Verificar archivos requeridos
echo ğŸ“‹ Verificando archivos del sistema...
set MISSING_FILES=0

set FILES=app.py models.py run.py migrate_database.py
for %%f in (%FILES%) do (
    if not exist "%%f" (
        echo âŒ Archivo faltante: %%f
        set MISSING_FILES=1
    )
)

if %MISSING_FILES% equ 1 (
    echo âŒ Archivos requeridos faltantes.
    echo    AsegÃºrese de tener todos los archivos del sistema.
    pause
    exit /b 1
)

echo âœ… Todos los archivos requeridos presentes
echo.

:: Instalar dependencias
echo ğŸ“¦ Instalando dependencias Python...
echo    Esto puede tomar varios minutos...
python -m pip install --upgrade pip >nul 2>&1
python -m pip install -r requirements.txt
if %errorlevel% neq 0 (
    echo âŒ Error instalando dependencias.
    echo    Verifique su conexiÃ³n a internet.
    pause
    exit /b 1
)

echo âœ… Dependencias instaladas correctamente
echo.

:: Migrar base de datos
echo ğŸ—„ï¸ Configurando base de datos...
python migrate_database.py
if %errorlevel% neq 0 (
    echo âŒ Error configurando base de datos.
    pause
    exit /b 1
)

echo âœ… Base de datos configurada
echo.

:: Inicializar aplicaciÃ³n
echo ğŸš€ Inicializando aplicaciÃ³n...
python -c "import sys; sys.path.append('.'); from app import app, init_database; app.app_context().push(); init_database(); print('AplicaciÃ³n inicializada')"
if %errorlevel% neq 0 (
    echo âŒ Error inicializando aplicaciÃ³n.
    pause
    exit /b 1
)

echo âœ… AplicaciÃ³n inicializada
echo.

:: Configurar firewall
echo ğŸ”¥ Configurando firewall...
netsh advfirewall firewall add rule name="EmergencySystemVA-HTTP" dir=in action=allow protocol=TCP localport=5000 >nul 2>&1
if %errorlevel% equ 0 (
    echo âœ… Regla de firewall agregada
) else (
    echo âš ï¸ No se pudo configurar firewall automÃ¡ticamente
)
echo.

:: Instalar servicio Windows (opcional)
echo ğŸ”§ Â¿Desea instalar como servicio Windows? (S/N):
set /p INSTALL_SERVICE=
if /i "%INSTALL_SERVICE%"=="S" (
    echo    Instalando servicio...
    if exist "service\emergency_service.py" (
        python service\emergency_service.py install
        if %errorlevel% equ 0 (
            echo âœ… Servicio instalado correctamente
            python service\emergency_service.py start
            if %errorlevel% equ 0 (
                echo âœ… Servicio iniciado
            )
        ) else (
            echo âš ï¸ Error instalando servicio
        )
    ) else (
        echo âš ï¸ Archivo de servicio no encontrado
    )
)
echo.

:: Crear accesos directos
echo ğŸ”— Creando accesos directos...

:: Escritorio
echo @echo off > "%USERPROFILE%\Desktop\Emergencia VA.bat"
echo cd /d "%CD%" >> "%USERPROFILE%\Desktop\Emergencia VA.bat"
echo start http://localhost:5000 >> "%USERPROFILE%\Desktop\Emergencia VA.bat"

:: Script de inicio
echo @echo off > start.bat
echo chcp 65001 ^>nul >> start.bat
echo echo ============================================ >> start.bat
echo echo ğŸš¨ SISTEMA DE EMERGENCIAS VILLA ALLENDE >> start.bat
echo echo ============================================ >> start.bat
echo cd /d "%CD%" >> start.bat
echo python run.py >> start.bat
echo pause >> start.bat

echo âœ… Accesos directos creados
echo.

:: Crear documentaciÃ³n
echo ğŸ“– Creando documentaciÃ³n...
echo ================================================ > INSTALACION_COMPLETADA.txt
echo ğŸš¨ SISTEMA DE EMERGENCIAS VILLA ALLENDE v2.0 >> INSTALACION_COMPLETADA.txt
echo ================================================ >> INSTALACION_COMPLETADA.txt
echo. >> INSTALACION_COMPLETADA.txt
echo âœ… INSTALACIÃ“N COMPLETADA EXITOSAMENTE >> INSTALACION_COMPLETADA.txt
echo. >> INSTALACION_COMPLETADA.txt
echo ğŸŒ ACCESO AL SISTEMA: >> INSTALACION_COMPLETADA.txt
echo    URL: http://localhost:5000 >> INSTALACION_COMPLETADA.txt
echo    Usuario: admin >> INSTALACION_COMPLETADA.txt
echo    ContraseÃ±a: 123456 >> INSTALACION_COMPLETADA.txt
echo. >> INSTALACION_COMPLETADA.txt
echo ğŸš€ CÃ“MO INICIAR: >> INSTALACION_COMPLETADA.txt
echo    - Doble clic en start.bat >> INSTALACION_COMPLETADA.txt
echo    - O usar servicio Windows si fue instalado >> INSTALACION_COMPLETADA.txt
echo. >> INSTALACION_COMPLETADA.txt
echo ğŸ“‹ NOVEDADES v2.0: >> INSTALACION_COMPLETADA.txt
echo    âœ… Campo email agregado en personas >> INSTALACION_COMPLETADA.txt
echo    âœ… MigraciÃ³n automÃ¡tica de base de datos >> INSTALACION_COMPLETADA.txt
echo    âœ… Sistema de backup mejorado >> INSTALACION_COMPLETADA.txt
echo    âœ… Herramientas de diagnÃ³stico >> INSTALACION_COMPLETADA.txt
echo    âœ… Instalador automÃ¡tico completo >> INSTALACION_COMPLETADA.txt
echo. >> INSTALACION_COMPLETADA.txt
echo ğŸ› ï¸ HERRAMIENTAS: >> INSTALACION_COMPLETADA.txt
echo    - DiagnÃ³stico: python tools\diagnostics.py >> INSTALACION_COMPLETADA.txt
echo    - Backup: python utils\backup.py create >> INSTALACION_COMPLETADA.txt
echo    - MigraciÃ³n: python migrate_database.py >> INSTALACION_COMPLETADA.txt
echo. >> INSTALACION_COMPLETADA.txt
echo ğŸ“§ SOPORTE: Consulte la documentaciÃ³n completa >> INSTALACION_COMPLETADA.txt
echo. >> INSTALACION_COMPLETADA.txt
echo Fecha de instalaciÃ³n: %DATE% %TIME% >> INSTALACION_COMPLETADA.txt

echo âœ… DocumentaciÃ³n creada
echo.

:: Resumen final
echo ================================================
echo ğŸ‰ INSTALACIÃ“N COMPLETADA EXITOSAMENTE
echo ================================================
echo.
echo ğŸŒ URL de acceso: http://localhost:5000
echo ğŸ‘¤ Usuario: admin
echo ğŸ”‘ ContraseÃ±a: 123456
echo.
echo ğŸš€ Para iniciar el sistema:
if /i "%INSTALL_SERVICE%"=="S" (
    echo    El servicio ya estÃ¡ ejecutÃ¡ndose
    echo    El sistema deberÃ­a estar disponible ahora
) else (
    echo    Ejecute: start.bat
)
echo.
echo ğŸ“‹ Cambios importantes en v2.0:
echo    âœ… Campo email agregado en tabla personas
echo    âœ… MigraciÃ³n automÃ¡tica implementada
echo    âœ… Herramientas de diagnÃ³stico incluidas
echo    âœ… Sistema de backup mejorado
echo.
echo ğŸ“– Consulte INSTALACION_COMPLETADA.txt para mÃ¡s detalles
echo.
echo Â¡SISTEMA LISTO PARA GESTIONAR EMERGENCIAS! ğŸš¨
echo ================================================

pause

# ===========================================
# start.bat - Script de Inicio
# ===========================================

@echo off
chcp 65001 >nul
title Sistema de Emergencias Villa Allende

echo ============================================
echo ğŸš¨ SISTEMA DE EMERGENCIAS VILLA ALLENDE
echo    VersiÃ³n 2.0 - Villa Allende, CÃ³rdoba
echo ============================================
echo.

:: Verificar Python
python --version >nul 2>&1
if %errorlevel% neq 0 (
    echo âŒ Python no encontrado.
    echo    Instale Python o verifique la instalaciÃ³n.
    pause
    exit /b 1
)

:: Cambiar al directorio del script
cd /d "%~dp0"

echo ğŸ Python OK
echo ğŸ“ Directorio: %CD%
echo ğŸ•’ Iniciando aplicaciÃ³n...
echo.
echo ğŸŒ Una vez iniciado, acceda a: http://localhost:5000
echo ğŸ‘¤ Usuario por defecto: admin
echo ğŸ”‘ ContraseÃ±a por defecto: 123456
echo.
echo âš ï¸  IMPORTANTE: Cambie la contraseÃ±a despuÃ©s del primer acceso
echo ğŸ›‘ Presione Ctrl+C para detener el sistema
echo.
echo ============================================

:: Ejecutar aplicaciÃ³n
python run.py

echo.
echo ğŸ‘‹ Sistema detenido
pause