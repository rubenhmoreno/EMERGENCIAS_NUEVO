#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Sistema de Emergencias Villa Allende
Integraci√≥n WhatsApp con Waboxapp

Funcionalidades:
- Env√≠o autom√°tico de mensajes por tipo de emergencia
- Ruteo inteligente seg√∫n prioridad y ubicaci√≥n
- M√∫ltiples destinatarios configurables
- Mensajes estructurados con toda la informaci√≥n
"""

import requests
import json
import logging
from datetime import datetime

class WhatsAppManager:
    def __init__(self):
        self.base_url = "https://www.waboxapp.com/api/send/chat"
        self.token = None
        self.uid = None
        self.logger = logging.getLogger(__name__)
        
        # Cargar configuraci√≥n
        self._load_config()
    
    def _load_config(self):
        """Cargar configuraci√≥n desde base de datos"""
        try:
            # Intentar cargar desde configuraci√≥n si est√° disponible
            from models import Configuracion
            
            token_config = Configuracion.query.filter_by(clave='whatsapp_token').first()
            uid_config = Configuracion.query.filter_by(clave='whatsapp_uid').first()
            
            if token_config:
                self.token = token_config.valor
            if uid_config:
                self.uid = uid_config.valor
                
        except Exception as e:
            self.logger.warning(f"No se pudo cargar configuraci√≥n WhatsApp: {e}")
    
    def configure(self, token, uid):
        """Configurar credenciales de WhatsApp"""
        self.token = token
        self.uid = uid
        
        # Guardar en base de datos si es posible
        try:
            from models import Configuracion, db
            
            # Actualizar o crear token
            token_config = Configuracion.query.filter_by(clave='whatsapp_token').first()
            if token_config:
                token_config.valor = token
            else:
                token_config = Configuracion(clave='whatsapp_token', valor=token)
                db.session.add(token_config)
            
            # Actualizar o crear UID
            uid_config = Configuracion.query.filter_by(clave='whatsapp_uid').first()
            if uid_config:
                uid_config.valor = uid
            else:
                uid_config = Configuracion(clave='whatsapp_uid', valor=uid)
                db.session.add(uid_config)
            
            db.session.commit()
            self.logger.info("Configuraci√≥n WhatsApp guardada")
            
        except Exception as e:
            self.logger.warning(f"No se pudo guardar configuraci√≥n: {e}")
    
    def is_configured(self):
        """Verificar si WhatsApp est√° configurado"""
        return bool(self.token and self.uid)
    
    def test_connection(self):
        """Probar conexi√≥n con WhatsApp"""
        if not self.is_configured():
            return {
                'success': False,
                'error': 'WhatsApp no configurado'
            }
        
        try:
            # Enviar mensaje de prueba al mismo n√∫mero
            test_message = f"üß™ Prueba de conexi√≥n - {datetime.now().strftime('%d/%m/%Y %H:%M')}"
            result = self.send_message(self.uid, test_message)
            
            return {
                'success': result,
                'message': 'Mensaje de prueba enviado' if result else 'Error enviando mensaje de prueba'
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
    
    def send_message(self, phone, message):
        """Enviar mensaje de WhatsApp"""
        if not self.is_configured():
            self.logger.error("WhatsApp no configurado")
            return False
        
        try:
            # Limpiar n√∫mero de tel√©fono
            phone = self._clean_phone_number(phone)
            
            # Preparar datos para la API
            data = {
                'token': self.token,
                'uid': self.uid,
                'to': phone,
                'custom_uid': f'emergency_{datetime.now().strftime("%Y%m%d_%H%M%S")}',
                'text': message
            }
            
            # Enviar request
            response = requests.post(self.base_url, data=data, timeout=30)
            response.raise_for_status()
            
            result = response.json()
            
            if result.get('sent', False):
                self.logger.info(f"WhatsApp enviado a {phone}")
                return True
            else:
                self.logger.error(f"Error enviando WhatsApp: {result}")
                return False
                
        except requests.exceptions.RequestException as e:
            self.logger.error(f"Error de conexi√≥n WhatsApp: {e}")
            return False
        except Exception as e:
            self.logger.error(f"Error enviando WhatsApp: {e}")
            return False
    
    def crear_mensaje_llamado(self, llamado):
        """Crear mensaje estructurado para un llamado"""
        # Mapear tipos de emergencia
        tipos_emoji = {
            'medica': 'üè•',
            'bomberos': 'üöí',
            'seguridad': 'üöî',
            'defensa': 'üå™Ô∏è',
            'otros': 'üìû'
        }
        
        # Mapear prioridades
        prioridades_emoji = {
            'rojo': 'üî¥',
            'amarillo': 'üü°',
            'verde': 'üü¢'
        }
        
        emoji_tipo = tipos_emoji.get(llamado.tipo, 'üìû')
        emoji_prioridad = prioridades_emoji.get(llamado.prioridad, 'üü¢')
        
        # Crear mensaje
        mensaje = f"""üö® EMERGENCIA VILLA ALLENDE

{emoji_tipo} TIPO: {llamado.tipo.upper()}
{emoji_prioridad} PRIORIDAD: {llamado.prioridad.upper()}

üë§ SOLICITANTE:
{llamado.nombre} {llamado.apellido}
üìû {llamado.telefono}

üìç UBICACI√ìN:
{llamado.direccion_completa}
{"üè†" if llamado.via_publica == "domicilio" else "üõ£Ô∏è"} {llamado.via_publica.replace("_", " ").title()}

üìù OBSERVACIONES:
{llamado.observaciones_iniciales or "Sin observaciones"}

‚è∞ HORA: {llamado.fecha.strftime("%d/%m/%Y %H:%M")}
üÜî LLAMADO: #{llamado.id}
üë®‚Äçüíº OPERADOR: {llamado.usuario.nombre}"""

        # Agregar informaci√≥n de triage si es m√©dica
        if llamado.tipo == 'medica' and llamado.triage_data:
            try:
                triage = json.loads(llamado.triage_data)
                if any(triage.values()):
                    mensaje += "\n\nü©∫ TRIAGE:"
                    if triage.get('consciente') == False:
                        mensaje += "\n‚ö†Ô∏è NO CONSCIENTE"
                    if triage.get('respira') == False:
                        mensaje += "\n‚ö†Ô∏è NO RESPIRA"
                    if triage.get('sangrado'):
                        mensaje += "\nü©∏ SANGRADO ABUNDANTE"
                    if triage.get('patologia'):
                        mensaje += "\n‚öïÔ∏è PATOLOG√çA GRAVE"
                    if triage.get('discapacidad'):
                        mensaje += "\n‚ôø DISCAPACIDAD"
            except:
                pass
        
        return mensaje
    
    def obtener_destinatarios(self, llamado):
        """Obtener lista de destinatarios seg√∫n tipo y prioridad"""
        destinatarios = []
        
        try:
            from models import Configuracion
            
            # Siempre incluir supervisor si est√° configurado
            supervisor = Configuracion.query.filter_by(clave='telefono_supervisor').first()
            if supervisor and supervisor.valor:
                destinatarios.append(supervisor.valor)
            
            # Destinatarios espec√≠ficos seg√∫n tipo y contexto
            if llamado.tipo == 'medica':
                if llamado.via_publica == 'domicilio':
                    if llamado.prioridad in ['rojo', 'amarillo']:
                        # DEMVA para emergencias rojas/amarillas en domicilio
                        demva = Configuracion.query.filter_by(clave='telefono_demva').first()
                        if demva and demva.valor:
                            destinatarios.append(demva.valor)
                    else:
                        # TELEMEDICINA para verdes en domicilio
                        telemedicina = Configuracion.query.filter_by(clave='telefono_telemedicina').first()
                        if telemedicina and telemedicina.valor:
                            destinatarios.append(telemedicina.valor)
                else:
                    # CEC para todas las emergencias en v√≠a p√∫blica
                    cec = Configuracion.query.filter_by(clave='telefono_cec').first()
                    if cec and cec.valor:
                        destinatarios.append(cec.valor)
            
            elif llamado.tipo == 'bomberos':
                bomberos = Configuracion.query.filter_by(clave='telefono_bomberos').first()
                if bomberos and bomberos.valor:
                    destinatarios.append(bomberos.valor)
            
            elif llamado.tipo == 'seguridad':
                seguridad = Configuracion.query.filter_by(clave='telefono_seguridad').first()
                if seguridad and seguridad.valor:
                    destinatarios.append(seguridad.valor)
            
            elif llamado.tipo == 'defensa':
                defensa = Configuracion.query.filter_by(clave='telefono_defensa').first()
                if defensa and defensa.valor:
                    destinatarios.append(defensa.valor)
            
        except Exception as e:
            self.logger.error(f"Error obteniendo destinatarios: {e}")
        
        # Eliminar duplicados manteniendo orden
        destinatarios_unicos = []
        for dest in destinatarios:
            if dest not in destinatarios_unicos:
                destinatarios_unicos.append(dest)
        
        return destinatarios_unicos
    
    def enviar_notificacion_llamado(self, llamado):
        """Enviar notificaci√≥n completa de un llamado"""
        if not self.is_configured():
            return {
                'success': False,
                'error': 'WhatsApp no configurado'
            }
        
        try:
            # Crear mensaje
            mensaje = self.crear_mensaje_llamado(llamado)
            
            # Obtener destinatarios
            destinatarios = self.obtener_destinatarios(llamado)
            
            if not destinatarios:
                return {
                    'success': False,
                    'error': 'No hay destinatarios configurados'
                }
            
            # Enviar a todos los destinatarios
            enviados = 0
            errores = []
            
            for destinatario in destinatarios:
                if self.send_message(destinatario, mensaje):
                    enviados += 1
                else:
                    errores.append(destinatario)
            
            return {
                'success': enviados > 0,
                'enviados': enviados,
                'total_destinatarios': len(destinatarios),
                'errores': errores,
                'destinatarios': destinatarios
            }
            
        except Exception as e:
            self.logger.error(f"Error enviando notificaci√≥n: {e}")
            return {
                'success': False,
                'error': str(e)
            }
    
    def enviar_mensaje_manual(self, telefono, mensaje, tipo='manual'):
        """Enviar mensaje manual"""
        if not self.is_configured():
            return {
                'success': False,
                'error': 'WhatsApp no configurado'
            }
        
        try:
            # Preparar mensaje con formato
            mensaje_formateado = f"""üì± MENSAJE MANUAL - VILLA ALLENDE

{mensaje}

‚è∞ {datetime.now().strftime("%d/%m/%Y %H:%M")}
üì® Tipo: {tipo.upper()}"""
            
            success = self.send_message(telefono, mensaje_formateado)
            
            return {
                'success': success,
                'message': 'Mensaje enviado correctamente' if success else 'Error enviando mensaje'
            }
            
        except Exception as e:
            return {
                'success': False,
                'error': str(e)
            }
    
    def _clean_phone_number(self, phone):
        """Limpiar y formatear n√∫mero de tel√©fono"""
        if not phone:
            return ""
        
        # Eliminar caracteres no num√©ricos
        clean_phone = ''.join(filter(str.isdigit, phone))
        
        # Agregar c√≥digo de pa√≠s argentino si no est√° presente
        if len(clean_phone) == 10:  # N√∫mero nacional
            clean_phone = "54" + clean_phone
        elif len(clean_phone) == 11 and clean_phone.startswith("0"):
            clean_phone = "54" + clean_phone[1:]
        elif len(clean_phone) == 13 and clean_phone.startswith("549"):
            # Ya tiene c√≥digo de pa√≠s con 9
            pass
        elif len(clean_phone) == 12 and clean_phone.startswith("54"):
            # Agregar 9 despu√©s del c√≥digo de pa√≠s
            clean_phone = clean_phone[:2] + "9" + clean_phone[2:]
        
        return clean_phone
    
    def get_status(self):
        """Obtener estado de la configuraci√≥n WhatsApp"""
        status = {
            'configured': self.is_configured(),
            'token_set': bool(self.token),
            'uid_set': bool(self.uid)
        }
        
        if self.is_configured():
            # Obtener configuraci√≥n de destinatarios
            try:
                from models import Configuracion
                
                destinatarios_config = [
                    'telefono_supervisor',
                    'telefono_demva',
                    'telefono_cec',
                    'telefono_telemedicina',
                    'telefono_bomberos',
                    'telefono_seguridad',
                    'telefono_defensa'
                ]
                
                destinatarios = {}
                for config_key in destinatarios_config:
                    config = Configuracion.query.filter_by(clave=config_key).first()
                    destinatarios[config_key] = bool(config and config.valor)
                
                status['destinatarios'] = destinatarios
                
            except Exception as e:
                self.logger.warning(f"Error obteniendo estado de destinatarios: {e}")
        
        return status

# Script principal para pruebas
if __name__ == '__main__':
    import sys
    
    wp_manager = WhatsAppManager()
    
    if len(sys.argv) > 1:
        action = sys.argv[1]
        
        if action == 'test' and len(sys.argv) > 3:
            token = sys.argv[2]
            uid = sys.argv[3]
            
            wp_manager.configure(token, uid)
            result = wp_manager.test_connection()
            
            if result['success']:
                print("‚úÖ Conexi√≥n WhatsApp exitosa")
            else:
                print(f"‚ùå Error: {result['error']}")
        
        elif action == 'status':
            status = wp_manager.get_status()
            print(f"üì± WhatsApp configurado: {status['configured']}")
            print(f"üîë Token configurado: {status['token_set']}")
            print(f"üìû UID configurado: {status['uid_set']}")
        
        else:
            print("Uso: python whatsapp.py [test <token> <uid>|status]")
    else:
        print("Uso: python whatsapp.py [test <token> <uid>|status]")
